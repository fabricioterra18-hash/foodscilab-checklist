<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>FoodSciLab ‚Ä¢ Checklist</title>

  <!-- Importante: caminhos RELATIVOS (funciona melhor na Vercel e em subpastas) -->
  <link rel="manifest" href="./manifest.json"/>
  <meta name="theme-color" content="#2563eb"/>
  <link rel="stylesheet" href="./app.css"/>

  <script defer src="./data.js"></script>
  <script defer src="./app.js"></script>
</head>

<body>
  <div class="container">

    <div class="header">
      <div class="brand">
        <div class="title">Checklist</div>
        <div class="subtitle">Marque tarefas, edite notas e acompanhe por fase.</div>
      </div>
      <div class="pill" id="summaryPill">‚è≥ Carregando‚Ä¶</div>
    </div>

    <div class="card">
      <div class="filters">
        <input id="q" class="input" placeholder="Buscar tarefa (ex.: wireframe, valida√ß√£o, vercel‚Ä¶)" />
        <select id="statusF" class="select">
          <option value="">Status (todos)</option>
          <option value="todo">A fazer</option>
          <option value="doing">Em andamento</option>
          <option value="done">Conclu√≠do</option>
        </select>
        <select id="prioF" class="select">
          <option value="">Prioridade (todas)</option>
          <option value="high">Alta</option>
          <option value="med">M√©dia</option>
          <option value="low">Baixa</option>
        </select>
      </div>

      <div id="list" class="list"></div>
    </div>

    <!-- Modal edi√ß√£o -->
    <div id="modal" class="modal" aria-hidden="true">
      <div class="sheet">
        <div class="sheetHead">
          <div>
            <div class="sheetTitle" id="mTitle">Editar</div>
            <div class="sheetSub" id="mPhase">‚Äî</div>
          </div>
          <button class="iconBtn" id="mClose" aria-label="Fechar">‚úï</button>
        </div>

        <div class="sheetBody">
          <div class="grid2">
            <label class="field">
              <span>Status</span>
              <select id="mStatus" class="select">
                <option value="todo">A fazer</option>
                <option value="doing">Em andamento</option>
                <option value="done">Conclu√≠do</option>
              </select>
            </label>

            <label class="field">
              <span>Prioridade</span>
              <select id="mPrio" class="select">
                <option value="high">Alta</option>
                <option value="med">M√©dia</option>
                <option value="low">Baixa</option>
              </select>
            </label>
          </div>

          <label class="field">
            <span>Prazo (texto livre)</span>
            <input id="mDue" class="input" placeholder="ex.: at√© 15/02 ou semana 3" />
          </label>

          <label class="field">
            <span>Notas</span>
            <textarea id="mNotes" class="textarea" rows="4" placeholder="O que precisa ser feito? Links, ideias, crit√©rios..."></textarea>
          </label>

          <label class="field">
            <span>Links (um por linha)</span>
            <textarea id="mLinks" class="textarea" rows="3" placeholder="https://...
https://..."></textarea>
          </label>
        </div>

        <div class="sheetFoot">
          <button class="btn ghost" id="mCancel">Cancelar</button>
          <button class="btn" id="mSave">Salvar</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        // Aguarda o seed + helpers carregarem
        function ready(fn){
          if(document.readyState === "complete" || document.readyState === "interactive") return fn();
          document.addEventListener("DOMContentLoaded", fn);
        }

        ready(function(){
          const listEl = document.getElementById("list");
          const q = document.getElementById("q");
          const statusF = document.getElementById("statusF");
          const prioF = document.getElementById("prioF");
          const pill = document.getElementById("summaryPill");

          const modal = document.getElementById("modal");
          const mTitle = document.getElementById("mTitle");
          const mPhase = document.getElementById("mPhase");
          const mStatus = document.getElementById("mStatus");
          const mPrio = document.getElementById("mPrio");
          const mDue = document.getElementById("mDue");
          const mNotes = document.getElementById("mNotes");
          const mLinks = document.getElementById("mLinks");

          let currentId = null;

          function esc(s){ return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

          function render(){
            const data = getData();
            const counts = taskCounts(data);
            pill.textContent = `‚úÖ ${counts.done}/${counts.total} ‚Ä¢ ${counts.pct}%`;

            const query = (q.value||"").trim().toLowerCase();
            const sf = statusF.value;
            const pf = prioF.value;

            const tasks = allTasks(data).filter(t=>{
              const okQ = !query || (t.title||"").toLowerCase().includes(query) || (t.phaseName||"").toLowerCase().includes(query);
              const okS = !sf || t.status === sf;
              const okP = !pf || t.prio === pf;
              return okQ && okS && okP;
            });

            // agrupa por fase
            const byPhase = new Map();
            tasks.forEach(t=>{
              if(!byPhase.has(t.phaseId)) byPhase.set(t.phaseId, { name: t.phaseName, items: [] });
              byPhase.get(t.phaseId).items.push(t);
            });

            if(tasks.length === 0){
              listEl.innerHTML = `<div class="empty">Nada encontrado. Tente outro termo ou limpe filtros.</div>`;
              return;
            }

            let html = "";
            for(const [phaseId, group] of byPhase.entries()){
              html += `<div class="section">
                <div class="sectionHead">
                  <div class="sectionTitle">${esc(group.name)}</div>
                </div>
                <div class="rows">`;

              group.items.forEach(t=>{
                const pr = formatPrio(t.prio);
                const checked = t.status === "done" ? "checked" : "";
                const statusLabel = t.status === "done" ? "Conclu√≠do" : (t.status === "doing" ? "Em andamento" : "A fazer");
                html += `<div class="row" data-id="${esc(t.id)}">
                  <label class="ck">
                    <input type="checkbox" ${checked} />
                    <span class="ckmark"></span>
                  </label>
                  <div class="rowMain">
                    <div class="rowTop">
                      <div class="rowTitle">${esc(t.title)}</div>
                      <div class="tag ${pr.cls}">${esc(pr.label)}</div>
                    </div>
                    <div class="rowMeta">
                      <span class="badge">${esc(statusLabel)}</span>
                      ${t.due ? `<span class="muted">‚Ä¢ Prazo: ${esc(t.due)}</span>` : ``}
                    </div>
                  </div>
                  <button class="iconBtn editBtn" aria-label="Editar">‚úé</button>
                </div>`;
              });

              html += `</div></div>`;
            }
            listEl.innerHTML = html;

            // binds
            listEl.querySelectorAll(".row").forEach(row=>{
              const id = row.getAttribute("data-id");
              const cb = row.querySelector('input[type="checkbox"]');
              const edit = row.querySelector(".editBtn");

              cb.addEventListener("change", ()=>{
                let d = getData();
                d = updateTask(d, id, (t)=>{ t.status = cb.checked ? "done" : "todo"; });
                setData(d);
                render();
              });

              edit.addEventListener("click", ()=> openModal(id));
              row.addEventListener("dblclick", ()=> openModal(id));
            });
          }

          function openModal(taskId){
            const d = getData();
            const found = findTask(d, taskId);
            if(!found) return;

            currentId = taskId;
            const t = found.task;

            mTitle.textContent = t.title || "Editar tarefa";
            mPhase.textContent = found.phase.name || "";
            mStatus.value = t.status || "todo";
            mPrio.value = t.prio || "med";
            mDue.value = t.due || "";
            mNotes.value = t.notes || "";
            mLinks.value = (t.links || []).join("\n");

            modal.classList.add("show");
            modal.setAttribute("aria-hidden","false");
          }

          function closeModal(){
            modal.classList.remove("show");
            modal.setAttribute("aria-hidden","true");
            currentId = null;
          }

          document.getElementById("mClose").addEventListener("click", closeModal);
          document.getElementById("mCancel").addEventListener("click", closeModal);
          modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

          document.getElementById("mSave").addEventListener("click", ()=>{
            if(!currentId) return;
            let d = getData();
            d = updateTask(d, currentId, (t)=>{
              t.status = mStatus.value;
              t.prio = mPrio.value;
              t.due = (mDue.value||"").trim();
              t.notes = mNotes.value || "";
              t.links = (mLinks.value||"").split("\n").map(s=>s.trim()).filter(Boolean);
            });
            setData(d);
            render();
            closeModal();
          });

          [q, statusF, prioF].forEach(el=> el.addEventListener("input", render));

          render();
        });
      })();
    </script>

  </div>

  <!-- Abas inferiores -->
  <nav class="tabs">
    <div class="inner">
      <a class="tab" href="index.html"><div class="ticon">üè†</div><div class="tlabel">Dashboard</div></a>
      <a class="tab active" href="checklist.html"><div class="ticon">‚úÖ</div><div class="tlabel">Checklist</div></a>
      <a class="tab" href="backlog.html"><div class="ticon">üóÇÔ∏è</div><div class="tlabel">Backlog</div></a>
      <a class="tab" href="settings.html"><div class="ticon">‚öôÔ∏è</div><div class="tlabel">Config</div></a>
    </div>
  </nav>
</body>
</html>
